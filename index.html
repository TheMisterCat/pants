<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SMRT Radio</title>
<style>
body { font-family: sans-serif; margin: 20px; background:#111; color:#eee; }
h1 { text-align:center; margin-bottom:10px; }
#controls { display:flex; justify-content:center; gap:10px; flex-wrap: wrap; margin-bottom:10px; }
#progress { width: 80%; margin: 0 auto 10px; display:block; }
input[type=range] { vertical-align: middle; }
#playlist { margin-top:20px; max-height:300px; overflow-y:auto; border-top:1px solid #444; padding-top:10px;}
.track { cursor:pointer; padding:5px; }
.track.active { background:#444; }
#visuals { display:flex; justify-content:center; align-items:flex-end; gap:20px; margin-bottom:20px; }
canvas { background:#222; border:1px solid #444; }
</style>
</head>
<body>
<h1>SMRT Radio</h1>

<div id="controls">
  <button id="prev">⏮ Prev</button>
  <button id="play">▶ Play</button>
  <button id="pause">⏸ Pause</button>
  <button id="stop">⏹ Stop</button>
  <button id="next">⏭ Next</button>
  Volume: <input type="range" id="volume" min="0" max="1" step="0.01" value="0.15">
  Low-Pass: <input type="range" id="lowpass" min="2000" max="20000" step="100" value="12000">
</div>

<div id="visuals">
  <canvas id="waveform" width="600" height="100"></canvas>
  <canvas id="peak" width="20" height="100"></canvas>
</div>

<input type="range" id="progress" value="0" min="0" max="100">

<div id="playlist"></div>

<script>
// --- CONFIG ---
const USER = "TheMisterCat";
const REPO = "pants";
const AUDIO_DIR = ""; // root

// --- GLOBALS ---
let audioContext = new (window.AudioContext || window.webkitAudioContext)();
let gainNode = audioContext.createGain();
let filterNode = audioContext.createBiquadFilter();
filterNode.type = "lowpass";
filterNode.frequency.value = 12000;

gainNode.connect(filterNode);
filterNode.connect(audioContext.destination);

let currentBufferSource = null;
let currentTrackIndex = 0;
let playlist = [];
let isPlaying = false;
let trackStartTime = 0;
let currentAudioBuffer = null;

// Canvas
const waveformCanvas = document.getElementById("waveform");
const waveformCtx = waveformCanvas.getContext("2d");
const peakCanvas = document.getElementById("peak");
const peakCtx = peakCanvas.getContext("2d");

// --- DFPWM Decoder ---
function decodeDFPWM(bytes) {
  let charge = 0;
  const strength = 0.25;
  const output = new Float32Array(bytes.length * 8);
  let sampleIndex = 0;
  for (let byte of bytes) {
    for (let i = 0; i < 8; i++) {
      const bit = (byte >> i) & 1;
      const target = bit ? 1 : -1;
      charge += (target - charge) * strength;
      let smoothed = charge * 0.95 + (sampleIndex > 0 ? 0.05 * output[sampleIndex - 1] : 0);

      // soft limiter
      const threshold = 0.9;
      if (smoothed > threshold) smoothed = threshold + (smoothed - threshold) * 0.2;
      if (smoothed < -threshold) smoothed = -threshold + (smoothed + threshold) * 0.2;

      output[sampleIndex++] = smoothed;
    }
  }
  return output;
}

// --- Load playlist ---
async function loadPlaylist() {
  const url = `https://api.github.com/repos/${USER}/${REPO}/contents/${AUDIO_DIR}`;
  const res = await fetch(url);
  const data = await res.json();
  playlist = data.filter(f => f.name.endsWith(".dfpwm"));
  renderPlaylist();
}

function renderPlaylist() {
  const container = document.getElementById("playlist");
  container.innerHTML = "";
  playlist.forEach((track, i) => {
    const div = document.createElement("div");
    div.textContent = track.name;
    div.className = "track" + (i === currentTrackIndex ? " active" : "");
    div.onclick = () => { playTrack(i); };
    container.appendChild(div);
  });
}

// --- Fetch & decode ---
async function fetchAndDecode(track) {
  const url = `https://raw.githubusercontent.com/${USER}/${REPO}/main/${AUDIO_DIR}${track.name}`;
  const res = await fetch(url);
  const arrayBuffer = await res.arrayBuffer();
  const bytes = new Uint8Array(arrayBuffer);
  const floatSamples = decodeDFPWM(bytes);

  const audioBuffer = audioContext.createBuffer(1, floatSamples.length, 48000);
  audioBuffer.getChannelData(0).set(floatSamples);
  return audioBuffer;
}

// --- Playback ---
async function playTrack(index) {
  stopTrack();
  currentTrackIndex = index;
  updateActiveTrack();

  currentAudioBuffer = await fetchAndDecode(playlist[index]);
  const source = audioContext.createBufferSource();
  source.buffer = currentAudioBuffer;
  source.connect(gainNode);
  source.start(0);
  trackStartTime = audioContext.currentTime;
  source.onended = () => { nextTrack(); };
  currentBufferSource = source;
  isPlaying = true;

  drawWaveform();
  updateProgress();
}

function stopTrack() {
  if (currentBufferSource) {
    currentBufferSource.stop();
    currentBufferSource.disconnect();
    currentBufferSource = null;
    isPlaying = false;
  }
}

function pauseTrack() {
  if (!audioContext) return;
  if (audioContext.state === "running") audioContext.suspend();
  else audioContext.resume();
}

function nextTrack() {
  currentTrackIndex = (currentTrackIndex + 1) % playlist.length;
  playTrack(currentTrackIndex);
}

function prevTrack() {
  currentTrackIndex = (currentTrackIndex - 1 + playlist.length) % playlist.length;
  playTrack(currentTrackIndex);
}

function updateActiveTrack() {
  document.querySelectorAll(".track").forEach((el,i)=>{
    el.classList.toggle("active", i===currentTrackIndex);
  });
}

// --- Volume & Low-Pass ---
document.getElementById("volume").addEventListener("input", e=>{
  gainNode.gain.value = parseFloat(e.target.value);
});
document.getElementById("lowpass").addEventListener("input", e=>{
  filterNode.frequency.value = parseFloat(e.target.value);
});

// --- Controls ---
document.getElementById("play").onclick = () => playTrack(currentTrackIndex);
document.getElementById("stop").onclick = stopTrack;
document.getElementById("pause").onclick = pauseTrack;
document.getElementById("next").onclick = nextTrack;
document.getElementById("prev").onclick = prevTrack;

// --- Progress bar ---
const progressEl = document.getElementById("progress");
function updateProgress() {
  if (!currentBufferSource || !isPlaying) return;
  const bufferLength = currentBufferSource.buffer.length / currentBufferSource.buffer.sampleRate;
  const elapsed = audioContext.currentTime - trackStartTime;
  progressEl.value = Math.min(100, (elapsed / bufferLength) * 100);
  requestAnimationFrame(updateProgress);
}

// --- Waveform & Peak Drawing ---
function drawWaveform() {
  if (!currentAudioBuffer) return;

  const data = currentAudioBuffer.getChannelData(0);
  const w = waveformCanvas.width;
  const h = waveformCanvas.height;
  waveformCtx.clearRect(0,0,w,h);
  waveformCtx.strokeStyle = "#0f0";
  waveformCtx.beginPath();
  const step = Math.ceil(data.length / w);
  for (let i=0;i<w;i++){
    const min = Math.min(...data.slice(i*step, (i+1)*step));
    const max = Math.max(...data.slice(i*step, (i+1)*step));
    waveformCtx.moveTo(i,h/2 - min*h/2);
    waveformCtx.lineTo(i,h/2 - max*h/2);
  }
  waveformCtx.stroke();

  drawPeak();
}

function drawPeak() {
  if (!currentAudioBuffer || !isPlaying) return;

  const data = currentAudioBuffer.getChannelData(0);
  const elapsedSamples = Math.floor((audioContext.currentTime - trackStartTime) * currentAudioBuffer.sampleRate);
  const currentSample = Math.min(elapsedSamples, data.length-1);
  const peak = Math.abs(data[currentSample]) * gainNode.gain.value;

  peakCtx.clearRect(0,0,peakCanvas.width, peakCanvas.height);
  peakCtx.fillStyle = "#f00";
  peakCtx.fillRect(0, peakCanvas.height*(1-peak), peakCanvas.width, peakCanvas.height*peak);
  
  requestAnimationFrame(drawPeak);
}

// --- Initialize ---
loadPlaylist();
</script>
</body>
</html>
