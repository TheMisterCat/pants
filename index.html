<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>DFPWM Radio</title>
</head>
<body>
<h1>DFPWM Radio</h1>
<ul id="trackList"></ul>
<button id="playRadio">Play Radio</button>

<script type="module">
import { decodeDFPWM } from './js/dfpwm.js';

const USER = "TheMisterCat";
const REPO = "pants";
const BRANCH = "main";

let playlist = [];
let currentIndex = 0;
let audioCtx = null;
let source = null;

async function fetchPlaylist() {
  const res = await fetch(`https://api.github.com/repos/${USER}/${REPO}/contents?ref=${BRANCH}`);
  const files = await res.json();
  playlist = files.filter(f => f.name.endsWith(".dfpwm")).map(f => f.name);

  const trackListEl = document.getElementById("trackList");
  trackListEl.innerHTML = "";
  playlist.forEach((name, idx) => {
    const li = document.createElement("li");
    li.textContent = name;
    li.addEventListener("click", () => playTrack(idx));
    trackListEl.appendChild(li);
  });
}

async function playTrack(index) {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();

  if (source) source.stop();

  currentIndex = index;
  const trackName = playlist[currentIndex];
  const url = `https://raw.githubusercontent.com/${USER}/${REPO}/${BRANCH}/${trackName}`;
  const res = await fetch(url);
  const buffer = new Uint8Array(await res.arrayBuffer());

  // Decode DFPWM
  const pcm = decodeDFPWM(buffer);

  // Create AudioBuffer
  const audioBuffer = audioCtx.createBuffer(1, pcm.length, 44100);
  audioBuffer.getChannelData(0).set(pcm);

  source = audioCtx.createBufferSource();
  source.buffer = audioBuffer;
  source.connect(audioCtx.destination);
  source.onended = playNextTrack;
  source.start();
}

function playNextTrack() {
  currentIndex = (currentIndex + 1) % playlist.length;
  playTrack(currentIndex);
}

document.getElementById("playRadio").addEventListener("click", () => {
  if (playlist.length > 0) playTrack(0);
});

fetchPlaylist();
</script>
</body>
</html>

